name: Manual Publish

on:
    workflow_dispatch:
        inputs:
            package:
                description: "Which package to publish"
                required: true
                type: choice
                options:
                    - catalyst-core
                    - catalyst-core-internal
                default: catalyst-core
            npm_tag:
                description: "NPM distribution tag"
                required: true
                type: choice
                options:
                    - latest
                    - beta
                    - canary
                    - custom
                default: latest
            custom_tag:
                description: 'Custom NPM tag (only if npm_tag is "custom")'
                required: false
                type: string
            version_bump:
                description: "Version bump type"
                required: true
                type: choice
                options:
                    - patch
                    - minor
                    - major
                    - custom
                default: patch
            custom_version:
                description: 'Custom version (only if version_bump is "custom", e.g., 2.0.0-rc.1)'
                required: false
                type: string

permissions:
    contents: read
    id-token: write

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  registry-url: "https://registry.npmjs.org"

            - name: Install rsync
              run: sudo apt-get update && sudo apt-get install -y rsync

            - name: Install dependencies
              run: npm ci

            - name: Build package
              run: npm run prepare

            - name: Configure Git
              run: |
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"
                  git config --global user.name "github-actions[bot]"

            - name: Rename package (if internal)
              if: github.event.inputs.package == 'catalyst-core-internal'
              run: |
                  # Update package.json name
                  npm pkg set name=catalyst-core-internal

                  # Replace all instances of 'catalyst-core' with 'catalyst-core-internal' in dist
                  find ./dist -type f \( -name "*.js" -o -name "*.ts" \) -exec sed -i 's/"catalyst-core"/"catalyst-core-internal"/g' {} +
                  find ./dist -type f \( -name "*.js" -o -name "*.ts" \) -exec sed -i "s/'catalyst-core'/'catalyst-core-internal'/g" {} +

            - name: Determine npm tag
              id: npm_tag
              run: |
                  if [ "${{ github.event.inputs.npm_tag }}" == "custom" ]; then
                    echo "tag=${{ github.event.inputs.custom_tag }}" >> $GITHUB_OUTPUT
                  else
                    echo "tag=${{ github.event.inputs.npm_tag }}" >> $GITHUB_OUTPUT
                  fi

            - name: Bump version
              run: |
                  VERSION_BUMP="${{ github.event.inputs.version_bump }}"

                  if [ "$VERSION_BUMP" == "custom" ]; then
                    # Set custom version
                    npm version ${{ github.event.inputs.custom_version }} --no-git-tag-version
                  else
                    # Standard version bump (patch, minor, major)
                    npm version $VERSION_BUMP --no-git-tag-version
                  fi

                  NEW_VERSION=$(node -p "require('./package.json').version")
                  echo "ðŸ“¦ Publishing ${{ github.event.inputs.package }}@$NEW_VERSION with tag ${{ steps.npm_tag.outputs.tag }}"

            - name: Publish to npm (DRY RUN)
              run: npm publish --dry-run --tag ${{ steps.npm_tag.outputs.tag }}
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Output published version
              run: |
                  PACKAGE_NAME="${{ github.event.inputs.package }}"
                  VERSION=$(node -p "require('./package.json').version")
                  NPM_TAG="${{ steps.npm_tag.outputs.tag }}"
                  echo "âœ… Successfully published $PACKAGE_NAME@$VERSION with tag '$NPM_TAG'"
                  echo ""
                  echo "ðŸ“¥ Install with:"
                  echo "   npm install $PACKAGE_NAME@$NPM_TAG"
                  echo "   npm install $PACKAGE_NAME@$VERSION"
                  echo ""
                  echo "ðŸ”— View on npm:"
                  echo "   https://www.npmjs.com/package/$PACKAGE_NAME/v/$VERSION"
